# -*- coding: utf-8 -*-
from __future__ import unicode_literals, print_function, absolute_import
from xlrd import open_workbook #,xldate
from .utils import mktable
from arcpy import CalculateField_management, SelectLayerByAttribute_management, FieldMappings, Merge_management
from arcpy.mapping import AddLayer,Layer,RemoveLayer
from arcpy.da import InsertCursor
from os import getcwd, remove
from os.path import join, dirname
from shutil import copy
from datetime import datetime
from .infr_social import inf_object

__all__ = ["come_comu"]

class come_comu(inf_object):
	def read_xlsx(self,book_dir):
		book = open_workbook(book_dir)
		sheet = book.sheet_by_name('Comedores')
		#self.rows = [[xldate.xldate_as_datetime(row.value, book.datemode).strftime('%d/%m/%Y') if row.ctype == 3 else unicode(row.value).upper() for row in sheet.row_slice(i)] for i in xrange(6,sheet.nrows)]
		self.rows = [[datetime.utcfromtimestamp((row.value-25569) * 86400.0).strftime('%d/%m/%Y') if row.ctype == 3 else unicode(row.value).upper() for row in sheet.row_slice(i)] for i in xrange(6,sheet.nrows)]
		

	def make_dbf(self):
		fields = [[u'CVE_ENT', u'TEXT', 0, 0, 2], [u'NOM_ENT', u'TEXT', 0, 0, 110], [u'NOM_REG', u'TEXT', 0, 0, 65], [u'CVE_MUNC', u'TEXT', 0, 0, 5], [u'NOM_MUN', u'TEXT', 0, 0, 110], [u'CVE_ORI', u'TEXT', 0, 0, 9],[u'CVE_LOCC', u'TEXT', 0, 0, 9], [u'NOM_LOC', u'TEXT', 0, 0, 110], [u'NOM_COM', u'TEXT', 0, 0, 90], [u'DIR_COM', u'TEXT', 0, 0, 254], [u'CVE_AGEB', u'TEXT', 0, 0, 4], [u'ZAP', u'TEXT', 0, 0, 3], [u'ID_COM', u'TEXT', 0, 0, 7], [u'ESTRATEGIA', u'TEXT', 0, 0, 7], [u'FEC_SOLCOM', u'TEXT', 0, 0, 10], [u'FEC_INSCOM', u'TEXT', 0, 0, 10], [u'FEC_CAPCOC', u'TEXT', 0, 0, 16], [u'FEC_INIOPE', u'TEXT', 0, 0, 10], [u'MOD_CAPA', u'TEXT', 0, 0, 16], [u'TIPO_COCIN', u'TEXT', 0, 0, 15], [u'CUOT_RECUP', u'TEXT', 0, 0, 16], [u'DIAS_SERVI', u'TEXT', 0, 0, 8], [u'VOCAL_SEXO', u'TEXT', 0, 0, 8], [u'VOCAL_NOM', u'TEXT', 0, 0, 43], [u'VOCAL_DOM', u'TEXT', 0, 0, 225], [u'VOCAL_TEL', u'TEXT', 0, 0, 15], [u'PP_TOT', u'SmallInteger', 3, 0, 3], [u'PP_MUJ', u'SmallInteger', 3, 0, 3], [u'PP_HOM', u'SmallInteger', 3, 0, 3], [u'NINAS_0_11', u'SmallInteger', 3, 0, 3], [u'NINOS_0_11', u'SmallInteger', 3, 0, 3], [u'EST_M12_19', u'SmallInteger', 2, 0, 2], [u'EST_H12_19', u'SmallInteger', 2, 0, 2], [u'MUJ_EMB', u'SmallInteger', 2, 0, 2], [u'MUJ_LAC', u'SmallInteger', 2, 0, 2], [u'MUJ_60YMAS', u'SmallInteger', 2, 0, 2], [u'HOM_60YMAS', u'SmallInteger', 2, 0, 2], [u'MUJ_DISC', u'SmallInteger', 2, 0, 2], [u'HOM_DISC', u'SmallInteger', 2, 0, 2], [u'MUJ_MIGRA', u'SmallInteger', 1, 0, 1], [u'HOM_MIGRA', u'SmallInteger', 2, 0, 2], [u'MUJ_SINEMP', u'SmallInteger', 2, 0, 2], [u'HOM_SINEMP', u'SmallInteger', 3, 0, 3], [u'MUJ_CONEME', u'SmallInteger', 1, 0, 1], [u'HOM_CONEME', u'SmallInteger', 1, 0, 1], [u'MUJ_COCVOL', u'SmallInteger', 2, 0, 2], [u'HOM_COCVOL', u'SmallInteger', 2, 0, 2], [u'TOT_COCVOL', u'SmallInteger', 2, 0, 2], [u'CR_NOM', u'TEXT', 0, 0, 37], [u'CR_SEXO', u'TEXT', 0, 0, 9], [u'CR_EDAD', u'TEXT', 0, 0, 9], [u'CR_DOMICIL', u'TEXT', 0, 0, 110], [u'CR_TEL', u'TEXT', 0, 0, 10], [u'CM_NOM', u'TEXT', 0, 0, 37], [u'CM_SEXO', u'TEXT', 0, 0, 6], [u'CM_EDAD', u'TEXT', 0, 0, 3], [u'CM_DOMICIL', u'TEXT', 0, 0, 127], [u'CM_TEL', u'TEXT', 0, 0, 10], [u'PROM_NOM', u'TEXT', 0, 0, 46], [u'PROM_SEXO', u'TEXT', 0, 0, 9], [u'PROM_EDAD', u'TEXT', 0, 0, 9], [u'PROM_DOMIC', u'TEXT', 0, 0, 124], [u'PROM_TEL', u'TEXT', 0, 0, 10], [u'LATITUD', u'Double', 17, 15, 18], [u'LONGITUD', u'Double', 17, 14, 18],[u'X_LAMB', u'Double', 18, 11, 19], [u'Y_LAMB', u'Double', 18, 11, 19],[u'STATUS', u'Double', 11, 0, 11]]#, [u'BIEN_2', u'TEXT', 0, 0, 16]]
		self.tab = mktable('COMEDORES_COMUNITARIOS.dbf',fields)
		with InsertCursor(self.tab,[fld[0] for fld in fields]) as ic:
			for row in self.rows:
				#for r in [62,63]:
				[row[62],row[63]] = come_comu.chk_coor(self,[row[62],row[63]])
				row = [row[i].split('.')[0] if i in [0,3,5,19,20,24,49,54,59] else row[i] for i in xrange(len(row))]
				ic.insertRow(row[:3]+[row[0]+row[3],row[4],row[0]+row[3]+row[5],u'']+row[6:]+[0,0,1])
		return self.tab

	def status(self):
		SelectLayerByAttribute_management(self.tab,"NEW_SELECTION",""" "PP_TOT" = 0 """)
		CalculateField_management(self.tab,"STATUS","0","PYTHON")
		SelectLayerByAttribute_management(self.tab,"CLEAR_SELECTION")

	def carto2010(self):
		remove('{0}.dbf'.format(self.tab.name))
		flm = FieldMappings()
		flm.loadFromString(u'CVE_ENT "CVE_ENT" true true false 2 Text 0 0 ,First,#,{0},CVE_ENT,-1,-1;NOM_ENT "NOM_ENT" true true false 110 Text 0 0 ,First,#,{0},NOM_ENT,-1,-1;NOM_REG "NOM_REG" true true false 65 Text 0 0 ,First,#,{0},NOM_REG,-1,-1;CVE_MUNC "CVE_MUNC" true true false 5 Text 0 0 ,First,#,{0},CVE_MUNC,-1,-1;NOM_MUN "NOM_MUN" true true false 110 Text 0 0 ,First,#,{0},NOM_MUN,-1,-1;CVE_LOCC "CVE_LOCC" true true false 9 Text 0 0 ,First,#,{0},CVE_LOCC,-1,-1;NOM_LOC "NOM_LOC" true true false 110 Text 0 0 ,First,#,{0},NOM_LOC,-1,-1;NOM_COM "NOM_COM" true true false 90 Text 0 0 ,First,#,{0},NOM_COM,-1,-1;DIR_COM "DIR_COM" true true false 254 Text 0 0 ,First,#,{0},DIR_COM,-1,-1;CVE_AGEB "CVE_AGEB" true true false 4 Text 0 0 ,First,#,{0},CVE_AGEB,-1,-1;ZAP "ZAP" true true false 3 Text 0 0 ,First,#,{0},ZAP,-1,-1;ID_COM "ID_COM" true true false 7 Text 0 0 ,First,#,{0},ID_COM,-1,-1;ESTRATEGIA "ESTRATEGIA" true true false 7 Text 0 0 ,First,#,{0},ESTRATEGIA,-1,-1;FEC_SOLCOM "FEC_SOLCOM" true true false 10 Text 0 0 ,First,#,{0},FEC_SOLCOM,-1,-1;FEC_INSCOM "FEC_INSCOM" true true false 10 Text 0 0 ,First,#,{0},FEC_INSCOM,-1,-1;FEC_CAPCOC "FEC_CAPCOC" true true false 16 Text 0 0 ,First,#,{0},FEC_CAPCOC,-1,-1;FEC_INIOPE "FEC_INIOPE" true true false 10 Text 0 0 ,First,#,{0},FEC_INIOPE,-1,-1;MOD_CAPA "MOD_CAPA" true true false 16 Text 0 0 ,First,#,{0},MOD_CAPA,-1,-1;TIPO_COCIN "TIPO_COCIN" true true false 15 Text 0 0 ,First,#,{0},TIPO_COCIN,-1,-1;CUOT_RECUP "CUOT_RECUP" true true false 16 Text 0 0 ,First,#,{0},CUOT_RECUP,-1,-1;DIAS_SERVI "DIAS_SERVI" true true false 8 Text 0 0 ,First,#,{0},DIAS_SERVI,-1,-1;VOCAL_SEXO "VOCAL_SEXO" true true false 8 Text 0 0 ,First,#,{0},VOCAL_SEXO,-1,-1;VOCAL_NOM "VOCAL_NOM" true true false 43 Text 0 0 ,First,#,{0},VOCAL_NOM,-1,-1;VOCAL_DOM "VOCAL_DOM" true true false 225 Text 0 0 ,First,#,{0},VOCAL_DOM,-1,-1;VOCAL_TEL "VOCAL_TEL" true true false 15 Text 0 0 ,First,#,{0},VOCAL_TEL,-1,-1;PP_TOT "PP_TOT" true true false 3 Short 0 3 ,First,#,{0},PP_TOT,-1,-1;PP_MUJ "PP_MUJ" true true false 3 Short 0 3 ,First,#,{0},PP_MUJ,-1,-1;PP_HOM "PP_HOM" true true false 3 Short 0 3 ,First,#,{0},PP_HOM,-1,-1;NINAS_0_11 "NINAS_0_11" true true false 3 Short 0 3 ,First,#,{0},NINAS_0_11,-1,-1;NINOS_0_11 "NINOS_0_11" true true false 3 Short 0 3 ,First,#,{0},NINOS_0_11,-1,-1;EST_M12_19 "EST_M12_19" true true false 2 Short 0 2 ,First,#,{0},EST_M12_19,-1,-1;EST_H12_19 "EST_H12_19" true true false 2 Short 0 2 ,First,#,{0},EST_H12_19,-1,-1;MUJ_EMB "MUJ_EMB" true true false 2 Short 0 2 ,First,#,{0},MUJ_EMB,-1,-1;MUJ_LAC "MUJ_LAC" true true false 2 Short 0 2 ,First,#,{0},MUJ_LAC,-1,-1;MUJ_60YMAS "MUJ_60YMAS" true true false 2 Short 0 2 ,First,#,{0},MUJ_60YMAS,-1,-1;HOM_60YMAS "HOM_60YMAS" true true false 2 Short 0 2 ,First,#,{0},HOM_60YMAS,-1,-1;MUJ_DISC "MUJ_DISC" true true false 2 Short 0 2 ,First,#,{0},MUJ_DISC,-1,-1;HOM_DISC "HOM_DISC" true true false 2 Short 0 2 ,First,#,{0},HOM_DISC,-1,-1;MUJ_MIGRA "MUJ_MIGRA" true true false 1 Short 0 1 ,First,#,{0},MUJ_MIGRA,-1,-1;HOM_MIGRA "HOM_MIGRA" true true false 2 Short 0 2 ,First,#,{0},HOM_MIGRA,-1,-1;MUJ_SINEMP "MUJ_SINEMP" true true false 2 Short 0 2 ,First,#,{0},MUJ_SINEMP,-1,-1;HOM_SINEMP "HOM_SINEMP" true true false 3 Short 0 3 ,First,#,{0},HOM_SINEMP,-1,-1;MUJ_CONEME "MUJ_CONEME" true true false 1 Short 0 1 ,First,#,{0},MUJ_CONEME,-1,-1;HOM_CONEME "HOM_CONEME" true true false 1 Short 0 1 ,First,#,{0},HOM_CONEME,-1,-1;MUJ_COCVOL "MUJ_COCVOL" true true false 2 Short 0 2 ,First,#,{0},MUJ_COCVOL,-1,-1;HOM_COCVOL "HOM_COCVOL" true true false 2 Short 0 2 ,First,#,{0},HOM_COCVOL,-1,-1;TOT_COCVOL "TOT_COCVOL" true true false 2 Short 0 2 ,First,#,{0},TOT_COCVOL,-1,-1;CR_NOM "CR_NOM" true true false 37 Text 0 0 ,First,#,{0},CR_NOM,-1,-1;CR_SEXO "CR_SEXO" true true false 9 Text 0 0 ,First,#,{0},CR_SEXO,-1,-1;CR_EDAD "CR_EDAD" true true false 9 Text 0 0 ,First,#,{0},CR_EDAD,-1,-1;CR_DOMICIL "CR_DOMICIL" true true false 110 Text 0 0 ,First,#,{0},CR_DOMICIL,-1,-1;CR_TEL "CR_TEL" true true false 10 Text 0 0 ,First,#,{0},CR_TEL,-1,-1;CM_NOM "CM_NOM" true true false 37 Text 0 0 ,First,#,{0},CM_NOM,-1,-1;CM_SEXO "CM_SEXO" true true false 6 Text 0 0 ,First,#,{0},CM_SEXO,-1,-1;CM_EDAD "CM_EDAD" true true false 3 Text 0 0 ,First,#,{0},CM_EDAD,-1,-1;CM_DOMICIL "CM_DOMICIL" true true false 127 Text 0 0 ,First,#,{0},CM_DOMICIL,-1,-1;CM_TEL "CM_TEL" true true false 10 Text 0 0 ,First,#,{0},CM_TEL,-1,-1;PROM_NOM "PROM_NOM" true true false 46 Text 0 0 ,First,#,{0},PROM_NOM,-1,-1;PROM_SEXO "PROM_SEXO" true true false 9 Text 0 0 ,First,#,{0},PROM_SEXO,-1,-1;PROM_EDAD "PROM_EDAD" true true false 9 Text 0 0 ,First,#,{0},PROM_EDAD,-1,-1;PROM_DOMIC "PROM_DOMIC" true true false 124 Text 0 0 ,First,#,{0},PROM_DOMIC,-1,-1;PROM_TEL "PROM_TEL" true true false 10 Text 0 0 ,First,#,{0},PROM_TEL,-1,-1;X_COORD "X_COORD" true true false 19 Double 11 18 ,First,#,{0},X_LAMB,-1,-1;Y_COORD "Y_COORD" true true false 19 Double 11 18 ,First,#,{0},Y_LAMB,-1,-1;STATUS "STATUS" true true false 11 Double 0 11 ,First,#,{0},STATUS,-1,-1'.format(self.lyer.name))
		Merge_management(self.lyer,join(u'CARTO2010','{0}.shp'.format(self.lyer.name)),flm)

	def productos_c(self):
		flm = FieldMappings()
		flm.loadFromString(u'CVE_ENT "CVE_ENT" true true false 2 Text 0 0 ,First,#,{0},CVE_ENT,-1,-1;NOM_ENT "NOM_ENT" true true false 110 Text 0 0 ,First,#,{0},NOM_ENT,-1,-1;NOM_REG "NOM_REG" true true false 65 Text 0 0 ,First,#,{0},NOM_REG,-1,-1;CVE_MUNC "CVE_MUNC" true true false 5 Text 0 0 ,First,#,{0},CVE_MUNC,-1,-1;NOM_MUN "NOM_MUN" true true false 110 Text 0 0 ,First,#,{0},NOM_MUN,-1,-1;CVE_LOCC "CVE_LOCC" true true false 9 Text 0 0 ,First,#,{0},CVE_LOCC,-1,-1;NOM_LOC "NOM_LOC" true true false 110 Text 0 0 ,First,#,{0},NOM_LOC,-1,-1;NOM_COM "NOM_COM" true true false 90 Text 0 0 ,First,#,{0},NOM_COM,-1,-1;DIR_COM "DIR_COM" true true false 254 Text 0 0 ,First,#,{0},DIR_COM,-1,-1;CVE_AGEB "CVE_AGEB" true true false 4 Text 0 0 ,First,#,{0},CVE_AGEB,-1,-1;ZAP "ZAP" true true false 3 Text 0 0 ,First,#,{0},ZAP,-1,-1;ID_COM "ID_COM" true true false 7 Text 0 0 ,First,#,{0},ID_COM,-1,-1;ESTRATEGIA "ESTRATEGIA" true true false 7 Text 0 0 ,First,#,{0},ESTRATEGIA,-1,-1;FEC_SOLCOM "FEC_SOLCOM" true true false 10 Text 0 0 ,First,#,{0},FEC_SOLCOM,-1,-1;FEC_INSCOM "FEC_INSCOM" true true false 10 Text 0 0 ,First,#,{0},FEC_INSCOM,-1,-1;FEC_CAPCOC "FEC_CAPCOC" true true false 16 Text 0 0 ,First,#,{0},FEC_CAPCOC,-1,-1;FEC_INIOPE "FEC_INIOPE" true true false 10 Text 0 0 ,First,#,{0},FEC_INIOPE,-1,-1;MOD_CAPA "MOD_CAPA" true true false 16 Text 0 0 ,First,#,{0},MOD_CAPA,-1,-1;TIPO_COCIN "TIPO_COCIN" true true false 15 Text 0 0 ,First,#,{0},TIPO_COCIN,-1,-1;CUOT_RECUP "CUOT_RECUP" true true false 16 Text 0 0 ,First,#,{0},CUOT_RECUP,-1,-1;DIAS_SERVI "DIAS_SERVI" true true false 8 Text 0 0 ,First,#,{0},DIAS_SERVI,-1,-1;VOCAL_SEXO "VOCAL_SEXO" true true false 8 Text 0 0 ,First,#,{0},VOCAL_SEXO,-1,-1;PP_TOT "PP_TOT" true true false 3 Short 0 3 ,First,#,{0},PP_TOT,-1,-1;PP_MUJ "PP_MUJ" true true false 3 Short 0 3 ,First,#,{0},PP_MUJ,-1,-1;PP_HOM "PP_HOM" true true false 3 Short 0 3 ,First,#,{0},PP_HOM,-1,-1;NINAS_0_11 "NINAS_0_11" true true false 3 Short 0 3 ,First,#,{0},NINAS_0_11,-1,-1;NINOS_0_11 "NINOS_0_11" true true false 3 Short 0 3 ,First,#,{0},NINOS_0_11,-1,-1;EST_M12_19 "EST_M12_19" true true false 2 Short 0 2 ,First,#,{0},EST_M12_19,-1,-1;EST_H12_19 "EST_H12_19" true true false 2 Short 0 2 ,First,#,{0},EST_H12_19,-1,-1;MUJ_EMB "MUJ_EMB" true true false 2 Short 0 2 ,First,#,{0},MUJ_EMB,-1,-1;MUJ_LAC "MUJ_LAC" true true false 2 Short 0 2 ,First,#,{0},MUJ_LAC,-1,-1;MUJ_60YMAS "MUJ_60YMAS" true true false 2 Short 0 2 ,First,#,{0},MUJ_60YMAS,-1,-1;HOM_60YMAS "HOM_60YMAS" true true false 2 Short 0 2 ,First,#,{0},HOM_60YMAS,-1,-1;MUJ_DISC "MUJ_DISC" true true false 2 Short 0 2 ,First,#,{0},MUJ_DISC,-1,-1;HOM_DISC "HOM_DISC" true true false 2 Short 0 2 ,First,#,{0},HOM_DISC,-1,-1;MUJ_MIGRA "MUJ_MIGRA" true true false 1 Short 0 1 ,First,#,{0},MUJ_MIGRA,-1,-1;HOM_MIGRA "HOM_MIGRA" true true false 2 Short 0 2 ,First,#,{0},HOM_MIGRA,-1,-1;MUJ_SINEMP "MUJ_SINEMP" true true false 2 Short 0 2 ,First,#,{0},MUJ_SINEMP,-1,-1;HOM_SINEMP "HOM_SINEMP" true true false 3 Short 0 3 ,First,#,{0},HOM_SINEMP,-1,-1;MUJ_CONEME "MUJ_CONEME" true true false 1 Short 0 1 ,First,#,{0},MUJ_CONEME,-1,-1;HOM_CONEME "HOM_CONEME" true true false 1 Short 0 1 ,First,#,{0},HOM_CONEME,-1,-1;MUJ_COCVOL "MUJ_COCVOL" true true false 2 Short 0 2 ,First,#,{0},MUJ_COCVOL,-1,-1;HOM_COCVOL "HOM_COCVOL" true true false 2 Short 0 2 ,First,#,{0},HOM_COCVOL,-1,-1;TOT_COCVOL "TOT_COCVOL" true true false 2 Short 0 2 ,First,#,{0},TOT_COCVOL,-1,-1'.format(self.lyer.name))
		Merge_management(self.lyer,join(u'PRODUCTOS_COMITE','{0}_COMEDORES_{1}.shp'.format(self.fch.strftime('%Y%m'),self.fch.strftime('%m%Y'))),flm)
		AddLayer(self.mxd.activeDataFrame,Layer(join('PRODUCTOS_COMITE','{0}_COMEDORES_{1}.shp'.format(self.fch.strftime('%Y%m'),self.fch.strftime('%m%Y')))))
		RemoveLayer(self.mxd.activeDataFrame,Layer(self.lyer.name))